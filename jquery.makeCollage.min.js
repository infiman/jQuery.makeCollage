(function(e){e.fn.makeCollage=function(t,n){var r=e.extend({targetHeight:t,albumWidth:e(this).width(),margin:n});var i=[];e(this).css("display","block");e(this).css("opacity",0);var s=e(this).children();s.css("float","left");s.css("position","relative");s.css("margin-bottom",r.margin);s.each(function(t){var n=e(this).children("img");n.css("z-index",-1);n.css("position","absolute");var s=e(this);n.each(function(t){var n=e(this);var o=n.width()/n.height()*r.targetHeight;var u=r.targetHeight;s.width(o);s.height(u);n.width(o);n.height(u);i.push([s,n])})});var o=0;var u=0;var a=0;var f=0;var l=0;var c=0;for(var h=0;h<i.length;h++){o+=i[h][1].width();if(o>=r.albumWidth){l=(r.albumWidth-a)/o;for(var p=f;p<=h;p++,f=p){if(p<h){i[p][0].width(Math.floor(i[p][0].width()*l));i[p][0].height(Math.floor(i[p][0].height()*l));i[p][1].width(Math.floor(i[p][1].width()*l));i[p][1].height(Math.floor(i[p][1].height()*l));i[p][0].css("margin-right",r.margin)}else if(p==h){i[p][0].width(r.albumWidth-c-a);i[p][0].height(Math.floor(i[p-1][0].height()));i[p][1].width(r.albumWidth-c-a);i[p][1].height(Math.floor(i[p-1][1].height()))}i[p][1].data("width",i[p][1].width());i[p][1].data("height",i[p][1].height());c+=Math.floor(i[p][1].width())}o=0;c=0;a=0}else{a+=r.margin}}var d=0;if(f<i.length){o=0;for(h=f;h<i.length;h++){o+=i[h][1].width();if(h<i.length-1){i[h][0].css("margin-right",r.margin)}i[h][1].data("width",i[h][1].width());i[h][1].data("height",i[h][1].height())}d=Math.ceil((r.albumWidth-o)/2)}e(this).fadeTo(1e3,1)}})(jQuery)